name: ðŸš€ Deploy to TestFlight

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-testflight
  cancel-in-progress: false

jobs:
  deploy:
    name: Build & Upload to TestFlight
    runs-on: macos-14
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Install Ruby dependencies
        run: |
          gem install bundler
          bundle install

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Deploy to TestFlight
        run: bundle exec fastlane beta
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.ASC_KEY_CONTENT }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          TEAM_ID: ${{ secrets.TEAM_ID }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
