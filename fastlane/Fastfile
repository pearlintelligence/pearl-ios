default_platform(:ios)

platform :ios do

  # ─── Before All ───────────────────────────────────────────────
  before_all do
    setup_ci if ENV["CI"]
  end

  # ─── Tests ────────────────────────────────────────────────────
  desc "Run unit tests and UI tests"
  lane :test do
    # Generate Xcode project from project.yml
    sh("cd .. && xcodegen generate")

    run_tests(
      project: "Pearl.xcodeproj",
      scheme: "Pearl",
      devices: ["iPhone 16"],
      clean: true,
      code_coverage: true,
      output_directory: "./fastlane/test_output",
      result_bundle: true
    )
  end

  # ─── Build ────────────────────────────────────────────────────
  desc "Build the app (no signing)"
  lane :build do
    sh("cd .. && xcodegen generate")

    build_app(
      project: "Pearl.xcodeproj",
      scheme: "Pearl",
      skip_codesigning: true,
      skip_archive: true,
      destination: "generic/platform=iOS"
    )
  end

  # ─── TestFlight ───────────────────────────────────────────────
  desc "Deploy to TestFlight"
  lane :beta do
    # Ensure clean state
    sh("cd .. && xcodegen generate")

    # Install signing certificate and provisioning profile
    setup_signing

    # Increment build number using latest TestFlight build
    app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: ENV["ASC_KEY_CONTENT"],
      is_key_content_base64: true,
      in_house: false
    )

    latest = latest_testflight_build_number(
      app_identifier: "com.innerpearl.pearl"
    )
    increment_build_number(
      build_number: latest + 1,
      xcodeproj: "Pearl.xcodeproj"
    )

    # Build and archive
    build_app(
      project: "Pearl.xcodeproj",
      scheme: "Pearl",
      export_method: "app-store",
      output_directory: "./fastlane/build",
      output_name: "Pearl.ipa"
    )

    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      distribute_external: false,
      changelog: changelog_from_git
    )

    # Notify
    UI.success("✦ Pearl #{lane_context[SharedValues::BUILD_NUMBER]} uploaded to TestFlight!")
  end

  # ─── App Store Release ────────────────────────────────────────
  desc "Deploy to App Store"
  lane :release do
    sh("cd .. && xcodegen generate")

    setup_signing

    app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: ENV["ASC_KEY_CONTENT"],
      is_key_content_base64: true,
      in_house: false
    )

    build_app(
      project: "Pearl.xcodeproj",
      scheme: "Pearl",
      export_method: "app-store",
      output_directory: "./fastlane/build",
      output_name: "Pearl.ipa"
    )

    upload_to_app_store(
      submit_for_review: false,
      automatic_release: false,
      force: true
    )

    UI.success("✦ Pearl uploaded to App Store Connect!")
  end

  # ─── Signing Setup ───────────────────────────────────────────
  private_lane :setup_signing do
    if ENV["CI"]
      # Use match for CI signing
      match(
        type: "appstore",
        app_identifier: "com.innerpearl.pearl",
        git_url: ENV["MATCH_GIT_URL"],
        readonly: true
      )
    else
      # Local development — use Xcode automatic signing
      UI.message("Using local Xcode signing")
    end
  end

  # ─── Changelog ────────────────────────────────────────────────
  private_lane :changelog_from_git do
    changelog = changelog_from_git_commits(
      between: [last_git_tag || "HEAD~10", "HEAD"],
      pretty: "- %s",
      merge_commit_filtering: "exclude_merges"
    )
    changelog.empty? ? "Bug fixes and improvements" : changelog
  end

  # ─── Error Handling ───────────────────────────────────────────
  error do |lane, exception|
    UI.error("#{lane} failed: #{exception.message}")
  end

end
